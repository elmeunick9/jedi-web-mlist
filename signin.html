<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="author" content="Robert Planas Jimenez">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>MList</title>

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
        <link rel="stylesheet" href="style.css"> 
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    </head>
    <body class="d-flex flex-column min-vh-100">
        <header class="sticky-top">
            <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
                <div class="container-fluid">
                    <a class="navbar-brand" href="#">
                        <img src="/logo.png" alt="" width="30" height="24">
                      </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                            <li class="nav-item">
                                <a class="nav-link" aria-current="page" href="/index.html">Home</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/mylist.html">My List</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/faq.html" tabindex="-1" aria-disabled="true">FAQ</a>
                            </li>
                        </ul>
                        <form class="d-flex" action="/signin.html">
                            <button class="btn btn-primary" type="submit" id="nav-sign">Sign In / Up</button>
                        </form>
                    </div>
                </div>
            </nav>
        </header>
        <main class="mt-lg-3">
            <h1 class="text-center display-1 mt-3">Sign in</h1>
            <h4 class="text-center">Login or register to our service.</h4>
            <div class="container mt-4 mb-4">
              <section class="row justify-content-center">
                <div class="col-12 m-lg-5">
                    <div class="card mb-3 p-5" style="max-width: 500px; margin: auto;">
                        <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
                            <li class="nav-item">
                              <a class="nav-link active" id="pills-signin-tab" data-toggle="pill" href="#" role="tab" aria-controls="pills-home" aria-selected="true">Login</a>
                            </li>
                            <li class="nav-item">
                              <a class="nav-link" id="pills-signup-tab" data-toggle="pill" href="#" role="tab" aria-controls="pills-profile" aria-selected="false">Register</a>
                            </li>
                        </ul>
                        <div class="tab-content" id="pills-tabContent">
                            <div class="tab-pane fade show active" id="pills-signin" role="tabpanel" aria-labelledby="pills-home-tab">
                                <form>
                                    <div class="form-group mb-2">
                                      <label for="email">Email address</label>
                                      <input type="email" class="form-control" id="email" placeholder="Enter email">
                                    </div>
                                    <div class="form-group">
                                      <label for="password">Password</label>
                                      <input type="password" class="form-control" id="password" placeholder="Password">
                                      <em><small class="text-danger"></small></em>
                                    </div>
                                    <br>
                                    <div class="float-end">
                                        <button type="submit" class="btn btn-primary" id="signin">Submit</button>
                                    </div>
                                </form>
                            </div>
                            <div class="tab-pane fade" id="pills-signup" role="tabpanel" aria-labelledby="pills-profile-tab">
                                <form>
                                    <div class="form-group mb-2">
                                        <label for="registerUsername">Username</label>
                                        <input type="text" class="form-control" id="registerUsername" placeholder="Name">
                                        <em><small class="text-danger"></small></em>
                                    </div>
                                    <div class="form-group mb-2">
                                      <label for="registerEmail">Email address</label>
                                      <input type="email" class="form-control" id="registerEmail" placeholder="Enter email">
                                      <em><small class="text-danger"></small></em>
                                    </div>
                                    <div class="form-group mb-2">
                                      <label for="registerPassword">Password</label>
                                      <input type="password" class="form-control" id="registerPassword" placeholder="Password">
                                      <em><small class="text-danger"></small></em>
                                    </div>
                                    <div class="form-group mb-2">
                                        <label for="registerRepeatPassword">Repeat Password</label>
                                        <input type="password" class="form-control" id="registerRepeatPassword" placeholder="Password">
                                        <em><small class="text-danger"></small></em>
                                    </div>
                                    <div class="form-group form-check">
                                        <input type="checkbox" class="form-check-input" id="registerCheck">
                                        <label class="form-check-label" for="registerCheck">I agree to terms and conditions.</label>
                                        <em><small class="text-danger"></small></em>
                                      </div>
                                    <div class="float-end">
                                        <button type="submit" class="btn btn-primary" id="registerButton" checked=false>Submit</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <small><a href="#" onclick="alert('Sorry, the [Password recovery] feature is not implemented yet!')">I forgot my password.</a></small>
                    </div>
                </div>
              </section>
            </div>
        </main>
        <footer class="bg-light text-center text-lg-start mt-auto">
            <div class="container p-4">
                <div class="row">
                    <div class="col-lg-6 col-md-12 mb-4 mb-md-0">
                        <h5 class="text-uppercase">What is MList?</h5>
                        <p>
                            MList is a brand new clone of MyAnimeList. Use it to keep track of you anime, manga or other media. 
                            You can rate them, sort them as you want and get specific notificiation when there are new avaliable episodes.
                        </p>
                    </div>
                    <div class="col-lg-6 col-md-12 mb-4 mb-md-0">
                        <h5 class="text-uppercase">Why should you use MList?</h5>
                        <p>
                            MList is the only web based anime traking app that allows to add you own private items to the database (WIP).
                            It is also the tracker with most useful customization features for their users.
                        </p>
                    </div>
                </div>
            </div>
            <div class="text-center p-3" style="background-color: rgba(0, 0, 0, 0.2)">
                Â© 2021 Copyright:
                <a class="text-dark" href="#">Robert Planas Jimenez</a>
            </div>
        </footer>
        <script>
            function getCookie(cname) {
            var name = cname + "=";
            var decodedCookie = decodeURIComponent(document.cookie);
            var ca = decodedCookie.split(';');
            for(var i = 0; i <ca.length; i++) {
              var c = ca[i];
              while (c.charAt(0) == ' ') {
                c = c.substring(1);
              }
              if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
              }
            }
            return "";
          }
          function setCookie(cname, cvalue, exdays) {
            var d = new Date();
            d.setTime(d.getTime() + (exdays*24*60*60*1000));
            var expires = "expires="+ d.toUTCString();
            document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
          }

          const baseurl = 'https://jedi-web-api-mlist.herokuapp.com'
          const userid = getCookie('userid')
          if (userid) {
            const navsign = document.getElementById('nav-sign')
            navsign.classList.remove('btn-primary')
            navsign.classList.add('btn-link')
            navsign.innerHTML = 'Log Out'
            navsign.onclick = (e) => {
              setCookie('userid', '', 1)
            }
          }

            const tabs = document.getElementById('pills-tab');
            [...tabs.getElementsByClassName('nav-link')].forEach(newTab => {
                newTab.onclick = (e) => {
                    const newPanel = document.getElementById(newTab.id.slice(0,-4))
                    const oldTab = tabs.getElementsByClassName('active')[0]
                    const oldPanel = document.getElementById(oldTab.id.slice(0,-4))
                    oldPanel.classList.toggle('show')
                    oldPanel.classList.toggle('active')
                    oldTab.classList.toggle('active')
                    newPanel.classList.toggle('show')
                    newPanel.classList.toggle('active')
                    newTab.classList.toggle('active')
                }
            })

            const name = document.getElementById('registerUsername')
            const email = document.getElementById("registerEmail")
            const password = document.getElementById("registerPassword")
            const confirm_password = document.getElementById("registerRepeatPassword")
            const check = document.getElementById("registerCheck")
            const button = document.getElementById("registerButton")

            function setValidity(element, text) {
                element.setCustomValidity(text)
                element.parentElement.getElementsByTagName('small')[0].innerHTML = text
            }

            function validateForm(){
                setValidity(email, email.value.length >= 3 ? '' : 'Please enter an email.')
                setValidity(password, password.value.length >= 6 ? '' : 'Please use at least 6 letters or numbers.')
                setValidity(confirm_password, confirm_password.value.length >= 6 ? 
                        (password.value == confirm_password.value ? '' : "Passwords don't match.")
                        : 'Please use at least 6 letters or numbers.'
                    )
                setValidity(check, check.checked ? '' : 'You need to accept the terms and conditions.')
                return (email.checkValidity() && password.checkValidity() && confirm_password.checkValidity() && check.checkValidity())
            }

            button.onclick = (e) => {
                if(validateForm()) {
                    axios.post(baseurl + '/user', {
                        "name": name.value,
                        "email": email.value,
                        "password": password.value,
                        "bookmark": []
                    }).then(response => {
                        setCookie("userid", response.data.id, 1)
                        alert('User created correctly, message sent!')
                        window.location = "/mylist.html"
                    })
                }
            }

            // ---- Normal SignIn
            document.getElementById('signin').onclick = (e) => {
                e.preventDefault()
                const email = document.getElementById('email').value
                const password = document.getElementById('password').value
                axios.get(baseurl + '/user?email=' + email)
                    .then(response => {
                        if (!response.data[0]) return
                        if (response.data[0].password === password) {
                            setCookie("userid", response.data[0].id, 1)
                            window.location = "/mylist.html"
                        } else {
                            document.getElementById('password').parentElement.
                                getElementsByTagName('small')[0].innerHTML = 'Incorrect username or password'
                        }
                    })
            }


        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>
    </body>
</html>